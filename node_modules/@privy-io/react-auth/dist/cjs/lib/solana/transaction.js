"use strict";var t=require("./index.js"),e=require("../../utils/buffer/readBigInt64LE.js"),n=require("../attempt.js");let r=new Intl.NumberFormat(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2});function o(t,e=6,n=!1,r=!1){let o=(parseFloat(t.toString())/1e9).toFixed(e).replace(/0+$/,"").replace(/\.$/,""),a=r?"":" SOL";return n?`${o}${a}`:`${"0"===o?"<0.001":o}${a}`}function a(t,e){let n=parseFloat(t.toString())/1e9,o=r.format(e*n);return"$0.00"===o?"<$0.01":o}function s(t){return"version"in t}async function i(t,e){return BigInt((s(t)?(await e.getFeeForMessage(t.message)).value:await t.getEstimatedFee(e))??0)}function c(t,n){try{return e.readBigInt64LEFromUint8Array(t,n)}catch{}try{return t.readBigInt64LE(n)}catch{}let r=Buffer.from(t);try{return e.readBigInt64LE(r)}catch{}try{return r.subarray(n).readBigInt64LE()}catch{}try{return r.readBigInt64LE(n)}catch{}return 0n}async function u(e,n,r,o,a,s){let i,u,[l,d,f]=e.accountKeyIndexes.map((t=>n.staticAccountKeys[t]));if(!l||!d||!f)throw Error("Failed to parse SPL transfer instruction");let m="",p=s[d.toBase58()];if(p)i=p.owner,m=p.mint;else{let t=await r.getParsedAccountInfo(d,"confirmed"),e=t.value?.data;i=e?.parsed?.info?.owner,m=e?.parsed?.info?.mint??"",u=e?.parsed?.info?.tokenAmount?.decimals}if(!m){let t=await r.getParsedAccountInfo(l,"confirmed"),e=t.value?.data;m=e?.parsed?.info?.mint??""}let A=a[m];if(m&&!A){let e=await o.getSplTokenMetadata({mintAddress:m,cluster:t.getSolanaNetworkFromRpcEndpoint(r.rpcEndpoint)});e&&(A={address:m,symbol:e.symbol,decimals:e.decimals})}let y=A?.symbol??"";u??=A?.decimals??9;let g=c(e.data,1);return{type:"spl-transfer",fromAta:l.toBase58(),fromAccount:f.toBase58(),toAta:d.toBase58(),toAccount:i,value:g,token:{symbol:y,decimals:u,address:m}}}async function l(t,e){let[n,r]=t.accountKeyIndexes.map((t=>e.staticAccountKeys[t]));if(!n||!r)throw Error("Failed to parse SOL transfer instruction");let o=c(t.data,4);return{type:"sol-transfer",fromAccount:n.toBase58(),toAccount:r.toBase58(),value:o,token:{symbol:"SOL",decimals:9}}}exports.ASSOCIATED_TOKEN_PROGRAM_ID="ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL",exports.LAMPORTS_PER_SOL=1e9,exports.SYSTEM_PROGRAM_ID="11111111111111111111111111111111",exports.TOKEN_2022_PROGRAM_ID="TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb",exports.TOKEN_PROGRAM_ID="TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA",exports.createSolanaTransactionReceipt=function(t,e){return{signature:t,parsedTransaction:e,fees:BigInt(e?.meta?.fee||0)}},exports.getDollarsFromLamport=a,exports.getNativeCurrencyFromLamports=o,exports.getSolanaFormattedAmounts=function({amount:t,fee:e,tokenPrice:n}){let r=BigInt(1e9*parseFloat(t)),s=r+e;return{fundingAmountInBaseUnit:r,fundingAmountInUsd:n?a(r,n):void 0,totalPriceInUsd:n?a(s,n):void 0,totalPriceInNativeCurrency:o(s),feePriceInNativeCurrency:o(e),feePriceInUsd:n?a(e,n):void 0}},exports.getTransactionFees=i,exports.getWalletPublicKeyFromTransaction=function(t,e){let n=(s(t)?t.message:t.compileMessage()).staticAccountKeys.find((t=>t.toBase58()===e));if(!n)throw Error(`Transaction does not contain public key ${e}`);return n},exports.hasSufficientFunds=async function(t,e){let{value:n}=await e.simulateTransaction(t);if("BlockhashNotFound"===n.err)throw Error("Simulation failed: Blockhash not found");return null==n.err&&n.logs?.every((t=>!/insufficient funds/gi.test(t)))},exports.isVersionedTransaction=s,exports.parseSolanaTransaction=async function({tx:t,connection:e,client:r}){let o=s(t)?t.message:t.compileMessage(),a=o.staticAccountKeys[0]?.toBase58()??"",c=await i(t,e),d={},f={},m=[];for(let t of o.compiledInstructions){let a=o.staticAccountKeys[t.programIdIndex]?.toBase58()||"";if("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"!==a&&"TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb"!==a)if("11111111111111111111111111111111"!==a)if("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"!==a)m.push({type:"unknown",program:a});else{let e=await n.attempt(function(t,e){let[n,r,o,a]=t.accountKeyIndexes.map((t=>e.staticAccountKeys[t]));if(!(n&&r&&o&&a))throw Error("Failed to parse ATA creation instruction");return{type:"ata-creation",payer:n.toBase58(),ata:r.toBase58(),owner:o.toBase58(),mint:a.toBase58()}}(t,o));if(!e)continue;m.push(e),f[e.ata]={owner:e.owner,mint:e.mint}}else{let e=await n.attempt(l(t,o));if(!e)continue;m.push(e)}else{let a=await n.attempt(u(t,o,e,r,d,f));if(!a)continue;m.push(a),d[a.token.address]=a.token,f[a.fromAta]??={owner:a.fromAccount,mint:a.token.address},a.toAccount&&(f[a.toAta]??={owner:a.toAccount,mint:a.token.address})}}let p=m.filter((({type:t})=>["spl-transfer","sol-transfer"].includes(t)));return{spender:a,fee:c,instructions:p.length?p:m}};
