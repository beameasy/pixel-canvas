"use strict";var e=require("react/jsx-runtime"),r=require("react"),n=require("viem"),i=require("@privy-io/js-sdk-core"),s=require("../../configuration/context.js"),o=require("../../connectors/errors.js"),t=require("../../constants.js"),a=require("../../embedded-wallets/rpc/index.js"),c=require("../../hooks/internal-context.js"),u=require("../../hooks/modal-context.js"),l=require("../../hooks/privy-context.js"),d=require("../../hooks/useGetTokenPrice.js"),p=require("../../hooks/useWalletBalance.js"),m=require("../../lib/erc20/actions/getErc20TokenInfo.js"),q=require("../../lib/erc20/formatErc20TokenAmount.js"),h=require("../../lib/ethers.js"),j=require("../../utils/index.js"),f=require("../../utils/eth/getPublicClient.js"),g=require("../ErrorScreen.js"),T=require("../index.js"),b=require("./ScanDetails.js"),y=require("./SendTransactionScreenView.js"),v=require("./TransactionErrorView.js"),S=require("./TransactionReceiptView.js"),I=require("./getStaticTransactionMetadata.js"),E=require("./lib.js"),C=require("./usePrepareTransaction.js");require("../../config.js"),require("../../configuration/defaultClientConfig.js"),require("../../configuration/login-methods.js"),require("../../configuration/wallets.js"),require("../../connectors/chains/index.js"),require("../../connectors/chains/arbitrum.js"),require("../../connectors/chains/arbitrumSepolia.js"),require("../../connectors/chains/avalanche.js"),require("../../connectors/chains/avalancheFuji.js"),require("../../connectors/chains/base.js"),require("../../connectors/chains/baseSepolia.js"),require("../../connectors/chains/berachainArtio.js"),require("../../connectors/chains/celo.js"),require("../../connectors/chains/celoAlfajores.js"),require("../../connectors/chains/filecoin.js"),require("../../connectors/chains/filecoinCalibration.js"),require("../../connectors/chains/garnetHolesky.js"),require("../../connectors/chains/holesky.js"),require("../../connectors/chains/linea.js"),require("../../connectors/chains/lineaTestnet.js"),require("../../connectors/chains/lukso.js"),require("../../connectors/chains/mainnet.js"),require("../../connectors/chains/optimism.js"),require("../../connectors/chains/optimismSepolia.js"),require("../../connectors/chains/polygon.js"),require("../../connectors/chains/polygonAmoy.js"),require("../../connectors/chains/redstone.js"),require("../../connectors/chains/sepolia.js"),require("../../connectors/chains/zora.js"),require("../../connectors/chains/zoraSepolia.js"),require("../../connectors/chains/zoraTestnet.js"),require("../../connectors/chains/utils.js"),require("../../lib/solana/index.js"),require("../../theme.js"),require("tinycolor2"),require("../../lib/cybr53.js"),require("../../errors.js"),require("ofetch"),require("../../hooks/index.js"),require("../../components/PrefetchedImage.js"),require("../../hooks/useGetSolPrice.js"),require("../../connectors/get-legacy-injected-providers.js"),require("../../connectors/is-wallet-installed.js"),require("@heroicons/react/24/outline/ExclamationTriangleIcon"),require("@heroicons/react/24/outline/PhoneIcon"),require("styled-components"),require("../../components/Button.js"),require("../../components/Loader.js"),require("../../components/CircleBorder.js"),require("../../components/ModalHeader.js"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("../../components/layout/StackedContainer.js"),require("../../embedded-wallets/errors.js"),require("../../embedded-wallets/types.js"),require("../../hooks/captcha-context.js"),require("../../lib/funding/reservoir.js"),require("../../svg/lock-closed.js"),require("../../components/ModalFooter.js"),require("../../svg/protected-by-privy.js"),require("../../components/primitives/JsonTree.js"),require("@heroicons/react/24/outline"),require("../../components/primitives/InteractiveLabel.js"),require("../../components/ui/typography/LabelSm.js"),require("../../components/ui/layout/Row.js"),require("../../components/ui/typography/ErrorMessage.js"),require("../../components/ui/typography/Subtitle.js"),require("../../components/ui/typography/Title.js"),require("../../components/ui/typography/Value.js"),require("../../components/ui/animation/LoadingSkeleton.js"),require("../../components/ui/wallet/Address.js"),require("@heroicons/react/24/outline/CheckIcon"),require("@heroicons/react/24/outline/Square2StackIcon"),require("../../components/ui/wallet/WalletInfoCard.js"),require("../../components/ui/chips/Chip.js"),require("../../components/ui/layout/Column.js"),require("../../components/ui/typography/LabelXs.js"),require("../../components/ui/wallet/shared.js"),require("../LandingScreen/styles.js"),require("./TokenDescription.js"),require("./TransactionDetail.js"),require("./TransactionValidation.js"),require("../../components/Checkbox.js"),require("../../components/Pill.js"),require("./useTransactionDetails.js"),require("@heroicons/react/24/outline/ClipboardDocumentCheckIcon"),require("@heroicons/react/24/outline/ClipboardDocumentIcon"),require("@heroicons/react/24/outline/ExclamationCircleIcon"),require("../../components/Layouts.js"),require("../../components/ScreenHeader.js"),require("../../components/embedded-wallets/TransactionDetails.js"),require("../../components/embedded-wallets/DisplayInfoItem.js"),require("../../components/embedded-wallets/PriceDisplay.js"),require("../../lib/solana/transaction.js"),require("../../utils/buffer/readBigInt64LE.js"),require("../../lib/attempt.js"),require("../../components/embedded-wallets/TransactionTotal.js"),require("../../components/primitives/Accordion/index.js"),require("@heroicons/react/24/outline/ChevronDownIcon"),require("../../components/primitives/Accordion/AccordionContext.js"),require("../../components/embedded-wallets/WalletLink.js"),require("../../lib/deployAccount/actions/abis/deployAccount.js"),require("../../lib/erc20/actions/abis/approve.js"),require("../../lib/erc20/actions/abis/transfer.js"),require("../../lib/erc721/actions/abis/mint.js"),require("../../lib/erc721/actions/abis/safeTransferFrom.js"),require("../../lib/erc721/actions/abis/setApprovalForAll.js"),require("../../lib/erc721/actions/abis/transferFrom.js"),require("../../lib/erc1155/actions/abis/safeBatchTransferFrom.js"),require("../../lib/erc1155/actions/abis/safeTransferFrom.js"),require("../../lib/viem/prepareTransactionRequest.js"),require("../../lib/viem/toViemTransactionSerializable.js");let k=new o.PrivyProviderRpcError(new o.ProviderRpcError("There was an issue preparing your transaction",i.ProviderErrors.E32603_DEFAULT_INTERNAL_ERROR.eipCode)),w=(e,r)=>e?.sendTransaction?"transactionRequest"in e.sendTransaction?e.sendTransaction.transactionRequest:e.sendTransaction.transactionRequests[r]:void 0;exports.SendTransactionScreen=()=>{let{data:x,onUserCloseViaDialogOrKeybindRef:A,setModalData:P,navigate:D}=u.usePrivyModal(),{rpcConfig:R,chains:F,closePrivyModal:O,walletProxy:M,client:W}=c.usePrivyInternal(),{getAccessToken:_,user:L}=l.usePrivyContext(),N=s.useAppConfig(),[B,V]=r.useState(0),U=(ye=x,ye?.sendTransaction?"transactionRequest"in ye.sendTransaction?0:ye.sendTransaction.transactionRequests.length-1:0),[H,G]=r.useState(w(x,B)),[$,z]=r.useState(null),[J,Q]=r.useState(),[X,K]=r.useState(!1),[Y,Z]=r.useState(null),[ee,re]=r.useState(null),[ne,ie]=r.useState(null),[se,oe]=r.useState(void 0),[te,ae]=r.useState(void 0),[ce,ue]=r.useState(!1),[le,de]=r.useState(!1),[pe,me]=r.useState([]),[qe,he]=r.useState([]),[je,fe]=r.useState(!1),[ge,Te]=r.useState(void 0),be="fiat-currency"===N.embeddedWallets.priceDisplay.primary;var ye;if(!H||!x?.sendTransaction||!x?.sendTransaction.transactingWallet)/*#__PURE__*/return e.jsx(g.ErrorScreenView,{error:Error("Invalid transaction request"),onClick:()=>{x?.sendTransaction?.onFailure(k),O({shouldCallAuthOnSuccess:!1})}});let{entropyId:ve,entropyIdVerifier:Se,transactingWallet:Ie}=x.sendTransaction,Ee=r.useMemo((()=>F.find((e=>Number(e.id)===Number(H.chainId)))),[H.chainId]),Ce=Ee?.nativeCurrency.symbol??"ETH",ke=r.useMemo((()=>I.getStaticTransactionMetadata(H.data,!!N.embeddedWallets.extendedCalldataDecoding)),[H.data]),{action:we,isErc20Ish:xe,isNFTIsh:Ae}=ke,{toAddress:Pe,tokenAddress:De}=r.useMemo((()=>({toAddress:ke.isErc20Ish?ke.transferTo:H.to??void 0,tokenAddress:ke.isErc20Ish?H.to:void 0})),[ke]);r.useEffect((()=>{H.to&&Ee&&xe&&m.getErc20TokenInfo({address:H.to,chain:Ee,rpcConfig:N.rpcConfig,privyAppId:N.id}).then(z).catch(console.error)}),[H.to,Ee]);let{tokenPrice:Re,isTokenPriceLoading:Fe}=d.useGetTokenPrice(H.chainId),{balance:Oe}=p.useWalletBalance({rpcConfig:N.rpcConfig,appId:N.id,address:Ie.address,chain:Ee}),Me=r.useMemo((()=>f.getPublicClient(Number(H.chainId),F,R,{appId:N.id})),[H.chainId,R]),We=C.usePrepareTransaction(H,Ie,Me);r.useEffect((()=>{G(w(x,B))}),[B]),r.useEffect((()=>{x.sendTransaction?.getIsSponsored?x.sendTransaction.getIsSponsored().then(Q).catch(console.error):Q(!1)}),[x.sendTransaction.getIsSponsored]);let _e=()=>{if(!X)return Y?x?.sendTransaction?.onSuccess({hash:Y}):ne||We?.errors[0]?x?.sendTransaction?.onFailure(ne??We?.errors[0]??k):x?.sendTransaction?.onFailure(new o.PrivyProviderRpcError(new o.ProviderRpcError("The user rejected the request",i.ProviderErrors.E4001_USER_REJECTED_REQUEST.eipCode))),O({shouldCallAuthOnSuccess:!1})};A.current=_e;let Le=!!(x.funding&&x.funding.supportedOptions.length>0),Ne=h.getNativeCurrencyFromWei(BigInt(We?.totalGasEstimate??0n),Ce),Be=be&&Re?h.getDollarsFromWei(BigInt(We?.totalGasEstimate??0n),Re):void 0,Ve=h.getNativeCurrencyFromWei(Oe??0n,Ce,void 0,!0),Ue=be&&Re?h.getDollarsFromWei(Oe??0n,Re):void 0,He=x.sendTransaction?.uiOptions?.transactionInfo?.title;He||(He="approve"===we?xe?"Confirm address":"Confirm action":`Approve ${we}`);let Ge=x.sendTransaction?.uiOptions?.description||(xe&&"approve"===we?`${N.name} would like your permission for ${j.formatWalletAddress(ke.spender)} to spend tokens on your behalf.`:`${N.name} wants your permission to approve the following transaction.`),$e=x.sendTransaction?.uiOptions?.transactionInfo?.contractInfo?.imgUrl?/*#__PURE__*/e.jsx("img",{src:x.sendTransaction.uiOptions.transactionInfo.contractInfo.imgUrl,alt:x.sendTransaction.uiOptions.transactionInfo.contractInfo.imgAltText}):null,ze=!(!We||We.errors[0]||We.hasFunds||!1!==J),Je=ze&&Le,Qe=Je?"Add funds":x.sendTransaction?.uiOptions?.buttonText||(B<U?"Continue":"Approve");if(r.useEffect((()=>{let e=(e,r,n)=>{if(r.isErc20Ish&&r.amount&&n)Te(q.formatErc20TokenAmount({amount:r.amount,decimals:n.decimals})),me([{value:ge,symbol:n?.symbol}]);else if(e.value){let r=BigInt(e.value),n=Re&&h.getDollarsFromWei(r,Re);me(be&&n?[{value:n}]:[{value:h.parseNativeCurrencyFromWei(r),symbol:Ce}])}else me(be?[{value:"$0"}]:[{value:"0",symbol:Ce}])},r=We?.tx??H;N.embeddedWallets.transactionScanning.enabled&&r?(fe(!0),(async e=>{if(W)return await W.scanTransaction({metadata:{domain:N.embeddedWallets.transactionScanning.domain},chain_id:e.chainId.toString(),request:{method:"eth_sendTransaction",params:[{from:e.from,to:e.to,value:e.value?.toString(),gas:e.gas?.toString(),gasPrice:e.gasPrice?.toString(),nonce:e.nonce?.toString(),data:e.data}]}})})(r).then((e=>{if(!e)throw Error("Transaction scan failed");if("Success"===e.validation.status&&("Benign"===e.validation.result_type?ae("safe"):"Warning"===e.validation.result_type?ae("warn"):"Malicious"===e.validation.result_type&&(ae("error"),de(!0))),"Success"!==e.simulation.status)throw Error("Simulation failed");{oe(e.simulation.params);let{assetsIn:r,assetsOut:n}=E.parseTokenDescriptions(e.simulation.assets_diffs,e.simulation.exposures);if(0===n.length&&0===r.length)throw Error("No tokens found");me(n),he(r)}fe(!1)})).catch((()=>{fe(!1),e(r,ke,$)}))):e(r,ke,$)}),[H,We?.tx,ke,$]),ee/*#__PURE__*/)return e.jsx(S.TransactionReceiptView,{txn:We?.tx??H,onClose:_e,receipt:ee,transactionInfo:x.sendTransaction?.uiOptions.transactionInfo,tokenPrice:Re,tokenSymbol:Ce,receiptHeader:x.sendTransaction?.uiOptions.successHeader,receiptDescription:x.sendTransaction?.uiOptions.successDescription});if(ne)/*#__PURE__*/return e.jsx(v.TransactionErrorView,{transactionError:ne,transactionHash:Y??void 0,network:"ethereum",chainId:We?.tx.chainId??H.chainId,onClose:_e,onRetry:({resetNonce:e})=>{ie(null);let r={...We?.tx??H};e&&(r.nonce=void 0),G(r)}});let Xe=0!==U&&"number"==typeof B&&0!==B?()=>{V(B-1)}:void 0;return ce&&se?/*#__PURE__*/e.jsx(b.default,{details:se,onBack:()=>ue(!1)}):/*#__PURE__*/e.jsx(y.SendTransactionScreenView,{transactionIndex:B,onBack:Xe,maxIndex:U,disabled:ze&&!Le||le,isSubmitting:X,submitError:ne,isPreparing:!We,isTokenPriceLoading:Fe,isTokenContractInfoLoading:!Ae&&!$,prepareError:We?.errors[0],symbol:$?.symbol,chain:Ee,img:$e,title:He,subtitle:Ge,txValue:H.value,fee:Be??Ne,isSponsored:J,from:Ie?.address??"",to:Pe,tokenAddress:De??void 0,network:N.chains.find((e=>e.id===H.chainId))?.name??"",transactionDetails:{...ke,formattedAmount:ge},cta:Qe,missingFunds:ze,action:we,balance:Ue??Ve,onClose:_e,onClick:Je?async()=>{if(!Ie)return;if(!Le)throw Error("Funding wallet is not enabled");let e=T.ModalScreen.FUNDING_METHOD_SELECTION_SCREEN;P({...x,funding:{...x.funding,methodScreen:e,chainType:"ethereum",amount:n.formatEther(BigInt(We?.tx.value??0)+BigInt(We?.totalGasEstimate?.toString()??0)),chain:Ee}}),D(e)}:async()=>{if(B<U)V(B+1);else{K(!0);try{let e=await _();if(X||!e||!Ie||!M||!L)return;let r=x?.sendTransaction?.onConfirm?await x.sendTransaction.onConfirm():await a.sendTransaction({accessToken:e,transactingWallet:Ie,entropyId:ve,entropyIdVerifier:Se,walletProxy:M,transactionRequest:We?.tx??H,publicClient:Me,requesterAppId:x.sendTransaction?.requesterAppId});if(Z(r),x.sendTransaction?.signOnly)return await new Promise((e=>setTimeout(e,t.DEFAULT_SUCCESS_SCREEN_DURATION_MS))),x?.sendTransaction?.onSuccess({hash:r}),O({shouldCallAuthOnSuccess:!1});let n=await Me.waitForTransactionReceipt({hash:r});if("reverted"===n.status)throw Error("Transaction failed");re(n)}catch(e){console.warn({transaction:We?.tx??H,error:e}),ie(e)}finally{K(!1)}}},validation:te,hasScanDetails:!!se,setIsScanDetailsOpen:ue,preventMaliciousTransaction:le,setPreventMaliciousTransaction:de,tokensSent:pe,tokensReceived:qe,isScanning:je,isCancellable:x.sendTransaction?.uiOptions?.isCancellable??!1})};
