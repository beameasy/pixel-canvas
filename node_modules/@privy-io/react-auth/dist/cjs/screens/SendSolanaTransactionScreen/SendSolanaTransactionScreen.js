"use strict";var e=require("react/jsx-runtime"),n=require("react"),r=require("viem"),o=require("@privy-io/js-sdk-core"),t=require("../../client/user.js"),s=require("../../configuration/context.js"),i=require("../../embedded-wallets/solana/transaction.js"),a=require("../../hooks/internal-context.js"),c=require("../../hooks/modal-context.js"),u=require("../../hooks/privy-context.js"),l=require("../../hooks/useGetSolPrice.js"),d=require("../../lib/solana/index.js"),p=require("../../lib/solana/transaction.js"),m=require("../ErrorScreen.js"),q=require("../SendTransactionScreen/SendTransactionScreenView.js"),j=require("../SendTransactionScreen/TransactionErrorView.js"),h=require("../index.js"),f=require("./SolanaTransactionReceiptView.js");require("viem/utils"),require("../../config.js"),require("../../configuration/defaultClientConfig.js"),require("../../constants.js"),require("../../configuration/login-methods.js"),require("../../configuration/wallets.js"),require("../../connectors/chains/index.js"),require("../../connectors/chains/arbitrum.js"),require("../../connectors/chains/arbitrumSepolia.js"),require("../../connectors/chains/avalanche.js"),require("../../connectors/chains/avalancheFuji.js"),require("../../connectors/chains/base.js"),require("../../connectors/chains/baseSepolia.js"),require("../../connectors/chains/berachainArtio.js"),require("../../connectors/chains/celo.js"),require("../../connectors/chains/celoAlfajores.js"),require("../../connectors/chains/filecoin.js"),require("../../connectors/chains/filecoinCalibration.js"),require("../../connectors/chains/garnetHolesky.js"),require("../../connectors/chains/holesky.js"),require("../../connectors/chains/linea.js"),require("../../connectors/chains/lineaTestnet.js"),require("../../connectors/chains/lukso.js"),require("../../connectors/chains/mainnet.js"),require("../../connectors/chains/optimism.js"),require("../../connectors/chains/optimismSepolia.js"),require("../../connectors/chains/polygon.js"),require("../../connectors/chains/polygonAmoy.js"),require("../../connectors/chains/redstone.js"),require("../../connectors/chains/sepolia.js"),require("../../connectors/chains/zora.js"),require("../../connectors/chains/zoraSepolia.js"),require("../../connectors/chains/zoraTestnet.js"),require("../../connectors/chains/utils.js"),require("../../theme.js"),require("tinycolor2"),require("../../lib/cybr53.js"),require("../../utils/buffer/readBigInt64LE.js"),require("../../lib/attempt.js"),require("../../hooks/index.js"),require("../../components/PrefetchedImage.js"),require("@heroicons/react/24/outline/ExclamationTriangleIcon"),require("@heroicons/react/24/outline/PhoneIcon"),require("styled-components"),require("../../components/Button.js"),require("../../components/Loader.js"),require("../../components/CircleBorder.js"),require("../../components/ModalHeader.js"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("../../components/layout/StackedContainer.js"),require("../../embedded-wallets/errors.js"),require("../../embedded-wallets/types.js"),require("../../errors.js"),require("ofetch"),require("../../hooks/captcha-context.js"),require("../../utils/index.js"),require("../../connectors/get-legacy-injected-providers.js"),require("../../connectors/is-wallet-installed.js"),require("../../utils/eth/getPublicClient.js"),require("../../svg/lock-closed.js"),require("@heroicons/react/24/outline"),require("../../components/ModalFooter.js"),require("../../svg/protected-by-privy.js"),require("../../components/primitives/InteractiveLabel.js"),require("../../components/ui/typography/LabelSm.js"),require("../../components/ui/layout/Row.js"),require("../../components/ui/typography/ErrorMessage.js"),require("../../components/ui/typography/Subtitle.js"),require("../../components/ui/typography/Title.js"),require("../../components/ui/typography/Value.js"),require("../../components/ui/animation/LoadingSkeleton.js"),require("../../components/ui/wallet/Address.js"),require("@heroicons/react/24/outline/CheckIcon"),require("@heroicons/react/24/outline/Square2StackIcon"),require("../../components/ui/wallet/WalletInfoCard.js"),require("../../components/ui/chips/Chip.js"),require("../../components/ui/layout/Column.js"),require("../../components/ui/typography/LabelXs.js"),require("../../components/ui/wallet/shared.js"),require("../LandingScreen/styles.js"),require("../SendTransactionScreen/TokenDescription.js"),require("../SendTransactionScreen/TransactionDetail.js"),require("../SendTransactionScreen/TransactionValidation.js"),require("../../components/Checkbox.js"),require("../../components/Pill.js"),require("../SendTransactionScreen/useTransactionDetails.js"),require("@heroicons/react/24/outline/ClipboardDocumentCheckIcon"),require("@heroicons/react/24/outline/ClipboardDocumentIcon"),require("@heroicons/react/24/outline/ExclamationCircleIcon"),require("@heroicons/react/24/outline/CheckCircleIcon"),require("../../components/CircleBackground.js"),require("../../components/Layouts.js"),require("../../components/ScreenHeader.js"),require("../../components/embedded-wallets/SolanaTransactionDetails.js"),require("@heroicons/react/24/outline/ChevronDownIcon"),require("../../components/embedded-wallets/PriceDisplay.js"),require("../../lib/ethers.js"),require("../../components/embedded-wallets/WalletLink.js");exports.SendSolanaTransactionScreen=()=>{let{data:g,onUserCloseViaDialogOrKeybindRef:y,setModalData:S,navigate:k}=c.usePrivyModal(),{client:b,closePrivyModal:w,walletProxy:T}=a.usePrivyInternal(),v=s.useAppConfig(),{user:A,getAccessToken:I}=u.usePrivyContext(),[C,x]=n.useState(g?.sendSolanaTransaction?.transactionRequest),[E,L]=n.useState(),[O,P]=n.useState(),[D,F]=n.useState(0),[M,V]=n.useState({value:0n,isLoading:!1}),[R,W]=n.useState(!1),[B,N]=n.useState(),[U,H]=n.useState(),$=g?.sendSolanaTransaction?.connection,z=g?.sendSolanaTransaction?.transactingWallet,G=E?.instructions.length??1,_=z?.imported?t.getImportedPrivySolanaWallet(A):t.getPrivyPrimaryWallet(A),X=d.getSolanaNetworkFromRpcEndpoint($?.rpcEndpoint||""),K="fiat-currency"===v.embeddedWallets.priceDisplay.primary,{solPrice:Q,isSolPriceLoading:J}=l.useGetSolPrice({enabled:K}),Y=n.useMemo((()=>{let e,n;if(!E)return;let o=E.spender;0===D&&z?.address===o&&(e=p.getNativeCurrencyFromLamports(E.fee));let t=p.getNativeCurrencyFromLamports(M.value,3,!0),s=E.instructions[D];if(!s)return{fee:e,spender:o,balance:t};if("unknown"===s.type)return{fee:e,spender:o,program:s.program,balance:t};if("ata-creation"===s.type)return{fee:e,spender:o,balance:t,tokenAccountOwner:s.owner,tokenAccount:s.ata,tokenAddress:s.mint};let i=s.fromAccount,a="sol-transfer"===s.type?s.toAccount:s.toAccount||s.toAta,c="spl-transfer"===s.type?s.token.address:void 0;return null!=e&&"SOL"===s.token.symbol&&(n=p.getNativeCurrencyFromLamports(s.value+E.fee)),{fee:e,spender:o,from:i,to:a,tokenAddress:c,amount:`${r.formatUnits(s.value,s.token.decimals)} ${s.token.symbol}`.trim(),total:n,balance:t}}),[E,D,z?.address,M]),Z=n.useMemo((()=>{let e,n;if(!E||!K||!Q||J)return;function o(...e){return p.getDollarsFromLamport(e.reduce(((e,n)=>e+n),0n),Q??0)}0===D&&z?.address===E.spender&&(e=o(E.fee));let t=o(M.value),s=E.instructions[D];return s&&"unknown"!==s.type&&"ata-creation"!==s.type?(null!=e&&"SOL"===s.token.symbol&&(n=o(s.value,E.fee)),{fee:e,amount:"SOL"===s.token.symbol?o(s.value):`${r.formatUnits(s.value,s.token.decimals)} ${s.token.symbol}`.trim(),total:n,balance:t}):{fee:e,balance:t}}),[E,K,Q,J,z?.address,D,M]),ee=n.useMemo((()=>{if(!E||M.isLoading||D>0)return!1;let e=E.instructions[D];if(!e)return!1;let n=0n;return z?.address===E.spender&&(n+=E.fee),"value"in e&&z?.address===e.fromAccount&&"SOL"===e.token.symbol&&(n+=e.value),M.value<n}),[E,M,D]);if(n.useEffect((()=>{!async function(){if(C&&$&&b)try{P(void 0);let e=await p.parseSolanaTransaction({tx:C,connection:$,client:b});L(e),F(0)}catch(e){console.error("Failed to prepare transaction",e),P(e)}}()}),[C,$,b]),n.useEffect((()=>{(async function(){if(!z||!$)return;V({value:M.value,isLoading:!0});let e=new o.SolanaClient({name:"mainnet-beta",rpcUrl:$.rpcEndpoint});V({value:await e.getBalance(z.address).catch((()=>0n))??0n,isLoading:!1})})().catch(console.error)}),[E,$]),!(C&&g?.sendSolanaTransaction&&z&&$)){let n=Error("Invalid transaction request");/*#__PURE__*/return e.jsx(m.ErrorScreenView,{error:n,onClick:()=>{g?.sendSolanaTransaction?.onFailure(n),w({shouldCallAuthOnSuccess:!1})}})}let ne=()=>{if(!R)return B?g?.sendSolanaTransaction?.onSuccess(B):(g?.sendSolanaTransaction?.onFailure(U??O??Error("User exited the modal before submitting the transaction")),F(0)),w({shouldCallAuthOnSuccess:!1})};y.current=ne;let re=g.sendTransaction?.uiOptions?.transactionInfo?.contractInfo?.imgUrl?/*#__PURE__*/e.jsx("img",{src:g.sendTransaction.uiOptions.transactionInfo.contractInfo.imgUrl,alt:g.sendTransaction.uiOptions.transactionInfo.contractInfo.imgAltText}):null,oe=!!(g.funding&&g.funding.supportedOptions.length>0),te=ee&&oe;return B?/*#__PURE__*/e.jsx(f.SolanaTransactionReceiptView,{instructions:E?.instructions.reduce(((e,n)=>("ata-creation"===n.type&&e.push({tokenAccountOwner:n.owner,tokenAccount:n.ata}),"spl-transfer"===n.type&&e.push({from:n.fromAccount,to:n.toAccount||n.toAta,amount:n.value,token:n.token}),"sol-transfer"===n.type&&e.push({from:n.fromAccount,to:n.toAccount,amount:n.value,token:n.token}),e)),[])??[],fees:0===D?B.fees:0n,onClose:ne,transactionInfo:g.sendTransaction?.uiOptions.transactionInfo,solPrice:Q,receiptHeader:g.sendTransaction?.uiOptions.successHeader,receiptDescription:g.sendTransaction?.uiOptions.successDescription,rpcEndpoint:$.rpcEndpoint}):U?/*#__PURE__*/e.jsx(j.TransactionErrorView,{transactionError:U,connection:$,onClose:ne,network:"solana",onRetry:async()=>{H(void 0);let{blockhash:e}=await $.getLatestBlockhash();p.isVersionedTransaction(C)?C.message.recentBlockhash=e:C.recentBlockhash=e,x(C)}}):/*#__PURE__*/e.jsx(q.SendSolanaTransactionScreenView,{img:re,title:g.sendTransaction?.uiOptions?.transactionInfo?.title||"Confirm transaction",subtitle:g.sendTransaction?.uiOptions?.description||`${v.name} wants your permission to approve the following transaction.`,cta:te?"Add funds":g.sendTransaction?.uiOptions?.buttonText||"Approve",transactionIndex:D,maxIndex:G-1,network:"mainnet-beta"==X?"Solana":X,blockExplorerUrl:"https://explorer.solana.com",total:K?Z?.total:Y?.total,amount:K?Z?.amount:Y?.amount,fee:K?Z?.fee:Y?.fee,balance:K?Z?.balance:Y?.balance,from:Y?.from,to:Y?.to,tokenAccount:Y?.tokenAccount,tokenAccountOwner:Y?.tokenAccountOwner,tokenAddress:Y?.tokenAddress,transactingWalletAddress:z.address,programAddress:Y?.program,disabled:ee&&!oe,isSubmitting:R,isPreparing:!E||M.isLoading,isTokenPriceLoading:K&&J,isMissingFunds:ee,submitError:U??void 0,parseError:O,onClick:te?async()=>{if(!z)return;if(!oe)throw Error("Funding wallet is not enabled");let e=h.ModalScreen.FUNDING_METHOD_SELECTION_SCREEN;S({...g,funding:{...g.funding,methodScreen:e}}),k(e)}:async()=>{if(D<(E?.instructions.length??1)-1)F(D+1);else try{W(!0);let e=await I();if(R||!e||!z||!T||!A||!_)return;let{rootWallet:n}=t.getSolanaSigningAndRootWallet(A,z.address);if(!n)throw Error("No root wallet for transacting wallet found");let{entropyId:r,entropyIdVerifier:o}=t.getEntropyDetailsFromAccount(n),{signature:s,receipt:a}=await i.sendSolanaTransaction({tx:C,accessToken:e,connection:$,walletProxy:T,entropyId:r,entropyIdVerifier:o,transactingWalletAddress:z.address,transactingWalletIndex:z.walletIndex??0,transactionOptions:g.sendSolanaTransaction?.transactionOptions});N(p.createSolanaTransactionReceipt(s,a))}catch(e){console.warn({transaction:C,error:e}),H(e)}finally{W(!1)}},onClose:ne,onBack:D>0&&G>1?()=>F(D-1):void 0})};
