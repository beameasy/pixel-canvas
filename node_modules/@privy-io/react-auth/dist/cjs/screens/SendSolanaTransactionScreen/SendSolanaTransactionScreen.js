"use strict";var e=require("react/jsx-runtime"),n=require("react"),r=require("viem"),o=require("@privy-io/js-sdk-core"),t=require("../../client/user.js"),s=require("../../configuration/context.js"),a=require("../../embedded-wallets/solana/transaction.js"),i=require("../../hooks/internal-context.js"),c=require("../../hooks/modal-context.js"),l=require("../../hooks/privy-context.js"),u=require("../../hooks/useGetSolPrice.js"),d=require("../../lib/solana/index.js"),p=require("../../lib/solana/transaction.js"),m=require("../ErrorScreen.js"),q=require("../SendTransactionScreen/SendTransactionScreenView.js"),j=require("../SendTransactionScreen/TransactionErrorView.js"),h=require("../index.js"),f=require("./SolanaTransactionReceiptView.js");require("viem/utils"),require("../../config.js"),require("../../configuration/defaultClientConfig.js"),require("../../constants.js"),require("../../configuration/login-methods.js"),require("../../configuration/wallets.js"),require("../../connectors/chains/index.js"),require("../../connectors/chains/arbitrum.js"),require("../../connectors/chains/arbitrumSepolia.js"),require("../../connectors/chains/avalanche.js"),require("../../connectors/chains/avalancheFuji.js"),require("../../connectors/chains/base.js"),require("../../connectors/chains/baseSepolia.js"),require("../../connectors/chains/berachainArtio.js"),require("../../connectors/chains/celo.js"),require("../../connectors/chains/celoAlfajores.js"),require("../../connectors/chains/filecoin.js"),require("../../connectors/chains/filecoinCalibration.js"),require("../../connectors/chains/garnetHolesky.js"),require("../../connectors/chains/holesky.js"),require("../../connectors/chains/linea.js"),require("../../connectors/chains/lineaTestnet.js"),require("../../connectors/chains/lukso.js"),require("../../connectors/chains/mainnet.js"),require("../../connectors/chains/optimism.js"),require("../../connectors/chains/optimismSepolia.js"),require("../../connectors/chains/polygon.js"),require("../../connectors/chains/polygonAmoy.js"),require("../../connectors/chains/redstone.js"),require("../../connectors/chains/sepolia.js"),require("../../connectors/chains/zora.js"),require("../../connectors/chains/zoraSepolia.js"),require("../../connectors/chains/zoraTestnet.js"),require("../../connectors/chains/utils.js"),require("../../theme.js"),require("tinycolor2"),require("../../lib/cybr53.js"),require("../../utils/buffer/readBigInt64LE.js"),require("../../lib/attempt.js"),require("../../hooks/index.js"),require("../../components/PrefetchedImage.js"),require("@heroicons/react/24/outline/ExclamationTriangleIcon"),require("@heroicons/react/24/outline/PhoneIcon"),require("styled-components"),require("../../components/Button.js"),require("../../components/Loader.js"),require("../../components/CircleBorder.js"),require("../../components/ModalHeader.js"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("../../components/layout/StackedContainer.js"),require("../../embedded-wallets/errors.js"),require("../../embedded-wallets/types.js"),require("../../errors.js"),require("ofetch"),require("../../hooks/captcha-context.js"),require("../../utils/index.js"),require("../../connectors/get-legacy-injected-providers.js"),require("../../connectors/is-wallet-installed.js"),require("../../utils/eth/getPublicClient.js"),require("../../lib/funding/reservoir.js"),require("../../svg/lock-closed.js"),require("@heroicons/react/24/outline"),require("../../components/ModalFooter.js"),require("../../svg/protected-by-privy.js"),require("../../components/primitives/InteractiveLabel.js"),require("../../components/ui/typography/LabelSm.js"),require("../../components/ui/layout/Row.js"),require("../../components/ui/typography/ErrorMessage.js"),require("../../components/ui/typography/Subtitle.js"),require("../../components/ui/typography/Title.js"),require("../../components/ui/typography/Value.js"),require("../../components/ui/animation/LoadingSkeleton.js"),require("../../components/ui/wallet/Address.js"),require("@heroicons/react/24/outline/CheckIcon"),require("@heroicons/react/24/outline/Square2StackIcon"),require("../../components/ui/wallet/WalletInfoCard.js"),require("../../components/ui/chips/Chip.js"),require("../../components/ui/layout/Column.js"),require("../../components/ui/typography/LabelXs.js"),require("../../components/ui/wallet/shared.js"),require("../LandingScreen/styles.js"),require("../SendTransactionScreen/TokenDescription.js"),require("../SendTransactionScreen/TransactionDetail.js"),require("../SendTransactionScreen/TransactionValidation.js"),require("../../components/Checkbox.js"),require("../../components/Pill.js"),require("../SendTransactionScreen/useTransactionDetails.js"),require("@heroicons/react/24/outline/ClipboardDocumentCheckIcon"),require("@heroicons/react/24/outline/ClipboardDocumentIcon"),require("@heroicons/react/24/outline/ExclamationCircleIcon"),require("@heroicons/react/24/outline/CheckCircleIcon"),require("../../components/CircleBackground.js"),require("../../components/Layouts.js"),require("../../components/ScreenHeader.js"),require("../../components/embedded-wallets/SolanaTransactionDetails.js"),require("@heroicons/react/24/outline/ChevronDownIcon"),require("../../components/embedded-wallets/PriceDisplay.js"),require("../../lib/ethers.js"),require("../../components/embedded-wallets/WalletLink.js");exports.SendSolanaTransactionScreen=()=>{let{data:S,onUserCloseViaDialogOrKeybindRef:g,setModalData:y,navigate:k}=c.usePrivyModal(),{client:b,closePrivyModal:T,walletProxy:w}=i.usePrivyInternal(),v=s.useAppConfig(),{user:I,getAccessToken:A}=l.usePrivyContext(),[x,C]=n.useState(S?.sendSolanaTransaction?.transactionRequest),[E,L]=n.useState(),[O,P]=n.useState(),[D,F]=n.useState(0),[M,V]=n.useState({value:0n,isLoading:!1}),[W,R]=n.useState(!1),[B,N]=n.useState(),[U,H]=n.useState(),$=S?.sendSolanaTransaction?.connection,z=S?.sendSolanaTransaction?.transactingWallet,G=S?.sendSolanaTransaction?.signOnly??!1,_=E?.instructions.length??1,X=z?.imported?t.getImportedPrivySolanaWallet(I):t.getPrivyPrimaryWallet(I),K=d.getSolanaNetworkFromRpcEndpoint($?.rpcEndpoint||""),Q="fiat-currency"===v.embeddedWallets.priceDisplay.primary,{solPrice:J,isSolPriceLoading:Y}=u.useGetSolPrice({enabled:Q}),Z=n.useMemo((()=>{let e,n;if(!E)return;let o=E.spender;0===D&&z?.address===o&&(e=p.getNativeCurrencyFromLamports(E.fee));let t=p.getNativeCurrencyFromLamports(M.value,3,!0),s=E.instructions[D];if(!s)return{fee:e,spender:o,balance:t};if("unknown"===s.type)return{fee:e,spender:o,program:s.program,balance:t};if("ata-creation"===s.type)return{fee:e,spender:o,balance:t,tokenAccountOwner:s.owner,tokenAccount:s.ata,tokenAddress:s.mint};let a=s.fromAccount,i="sol-transfer"===s.type?s.toAccount:s.toAccount||s.toAta,c="spl-transfer"===s.type?s.token.address:void 0;return null!=e&&"SOL"===s.token.symbol&&(n=p.getNativeCurrencyFromLamports(s.value+E.fee)),{fee:e,spender:o,from:a,to:i,tokenAddress:c,amount:`${r.formatUnits(s.value,s.token.decimals)} ${s.token.symbol}`.trim(),total:n,balance:t}}),[E,D,z?.address,M]),ee=n.useMemo((()=>{let e,n;if(!E||!Q||!J||Y)return;function o(...e){return p.getDollarsFromLamport(e.reduce(((e,n)=>e+n),0n),J??0)}0===D&&z?.address===E.spender&&(e=o(E.fee));let t=o(M.value),s=E.instructions[D];return s&&"unknown"!==s.type&&"ata-creation"!==s.type?(null!=e&&"SOL"===s.token.symbol&&(n=o(s.value,E.fee)),{fee:e,amount:"SOL"===s.token.symbol?o(s.value):`${r.formatUnits(s.value,s.token.decimals)} ${s.token.symbol}`.trim(),total:n,balance:t}):{fee:e,balance:t}}),[E,Q,J,Y,z?.address,D,M]),ne=n.useMemo((()=>{if(G||!E||M.isLoading||D>0)return!1;let e=E.instructions[D];if(!e)return!1;let n=0n;return z?.address===E.spender&&(n+=E.fee),"value"in e&&z?.address===e.fromAccount&&"SOL"===e.token.symbol&&(n+=e.value),M.value<n}),[E,M,D,G]);if(n.useEffect((()=>{!async function(){if(x&&$&&b)try{P(void 0);let e=await p.parseSolanaTransaction({tx:x,connection:$,client:b});L(e),F(0)}catch(e){console.error("Failed to prepare transaction",e),P(e)}}()}),[x,$,b]),n.useEffect((()=>{(async function(){if(!z||!$)return;V({value:M.value,isLoading:!0});let e=new o.SolanaClient({name:"mainnet-beta",rpcUrl:$.rpcEndpoint});V({value:await e.getBalance(z.address).catch((()=>0n))??0n,isLoading:!1})})().catch(console.error)}),[E,$]),!(x&&S?.sendSolanaTransaction&&z&&$)){let n=Error("Invalid transaction request");/*#__PURE__*/return e.jsx(m.ErrorScreenView,{error:n,onClick:()=>{S?.sendSolanaTransaction?.onFailure(n),T({shouldCallAuthOnSuccess:!1})}})}let re=()=>{if(!W)return B?S?.sendSolanaTransaction?.onSuccess(B):(S?.sendSolanaTransaction?.onFailure(U??O??Error("User exited the modal before submitting the transaction")),F(0)),T({shouldCallAuthOnSuccess:!1})};g.current=re;let oe=S.sendSolanaTransaction?.uiOptions?.transactionInfo?.contractInfo?.imgUrl?/*#__PURE__*/e.jsx("img",{src:S.sendSolanaTransaction.uiOptions.transactionInfo.contractInfo.imgUrl,alt:S.sendSolanaTransaction.uiOptions.transactionInfo.contractInfo.imgAltText}):null,te=!!(S.funding&&S.funding.supportedOptions.length>0),se=ne&&te;return B?/*#__PURE__*/e.jsx(f.SolanaTransactionReceiptView,{instructions:E?.instructions.reduce(((e,n)=>("ata-creation"===n.type&&e.push({tokenAccountOwner:n.owner,tokenAccount:n.ata}),"spl-transfer"===n.type&&e.push({from:n.fromAccount,to:n.toAccount||n.toAta,amount:n.value,token:n.token}),"sol-transfer"===n.type&&e.push({from:n.fromAccount,to:n.toAccount,amount:n.value,token:n.token}),e)),[])??[],fees:0===D?B.fees:0n,onClose:re,transactionInfo:S.sendSolanaTransaction?.uiOptions.transactionInfo,solPrice:J,receiptHeader:S.sendSolanaTransaction?.uiOptions.successHeader,receiptDescription:S.sendSolanaTransaction?.uiOptions.successDescription,rpcEndpoint:$.rpcEndpoint,signOnly:G}):U?/*#__PURE__*/e.jsx(j.TransactionErrorView,{transactionError:U,connection:$,onClose:re,network:"solana",onRetry:async()=>{H(void 0);let{blockhash:e}=await $.getLatestBlockhash();p.isVersionedTransaction(x)?x.message.recentBlockhash=e:x.recentBlockhash=e,C(x)}}):/*#__PURE__*/e.jsx(q.SendSolanaTransactionScreenView,{img:oe,title:S.sendSolanaTransaction?.uiOptions?.transactionInfo?.title||"Confirm transaction",subtitle:S.sendSolanaTransaction?.uiOptions?.description||`${v.name} wants your permission to approve the following transaction.`,cta:se?"Add funds":S.sendSolanaTransaction?.uiOptions?.buttonText||"Approve",transactionIndex:D,maxIndex:_-1,network:"mainnet-beta"==K?"Solana":K,blockExplorerUrl:"https://explorer.solana.com",total:Q?ee?.total:Z?.total,amount:Q?ee?.amount:Z?.amount,fee:Q?ee?.fee:Z?.fee,balance:Q?ee?.balance:Z?.balance,from:Z?.from,to:Z?.to,tokenAccount:Z?.tokenAccount,tokenAccountOwner:Z?.tokenAccountOwner,tokenAddress:Z?.tokenAddress,transactingWalletAddress:z.address,programAddress:Z?.program,disabled:ne&&!te,isSubmitting:W,isPreparing:!E||M.isLoading,isTokenPriceLoading:Q&&Y,isMissingFunds:ne,submitError:U??void 0,parseError:O,onClick:se?async()=>{if(!z)return;if(!te)throw Error("Funding wallet is not enabled");let e=h.ModalScreen.FUNDING_METHOD_SELECTION_SCREEN;y({...S,funding:{...S.funding,methodScreen:e}}),k(e)}:async()=>{if(D<(E?.instructions.length??1)-1)F(D+1);else try{R(!0);let e=await A();if(W||!e||!z||!w||!I||!X)return;let{rootWallet:n}=t.getSolanaSigningAndRootWallet(I,z.address);if(!n)throw Error("No root wallet for transacting wallet found");let{entropyId:r,entropyIdVerifier:o}=t.getEntropyDetailsFromAccount(n);if(G)await a.signSolanaTransaction({tx:x,accessToken:e,walletProxy:w,entropyId:r,entropyIdVerifier:o,transactingWalletAddress:z.address,transactingWalletIndex:z.walletIndex??0}),N(p.createSolanaTransactionReceipt("",x,null));else{let{signature:n,receipt:t}=await a.sendSolanaTransaction({tx:x,accessToken:e,connection:$,walletProxy:w,entropyId:r,entropyIdVerifier:o,transactingWalletAddress:z.address,transactingWalletIndex:z.walletIndex??0,transactionOptions:S.sendSolanaTransaction?.transactionOptions});N(p.createSolanaTransactionReceipt(n,x,t))}}catch(e){console.warn({transaction:x,error:e}),H(e)}finally{R(!1)}},onClose:re,onBack:D>0&&_>1?()=>F(D-1):void 0})};
