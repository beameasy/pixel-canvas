"use strict";var e=require("react/jsx-runtime"),r=require("@heroicons/react/24/outline/CheckCircleIcon"),n=require("react"),i=require("viem"),t=require("../../components/Layouts.js"),s=require("../../components/ModalFooter.js"),o=require("../../components/ScreenHeader.js"),a=require("../../components/embedded-wallets/FundWalletMethodHeader.js"),c=require("../../components/primitives/NeutralSpinner/index.js"),u=require("../../connectors/chains/utils.js"),l=require("../../constants.js"),d=require("../../errors.js"),h=require("../../hooks/internal-context.js"),q=require("../../hooks/modal-context.js"),g=require("../../hooks/useGetTokenPrice.js"),j=require("../../hooks/useWallets.js"),m=require("../../lib/erc20/actions/abis/transfer.js"),p=require("../../lib/erc20/formatErc20TokenAmount.js"),f=require("../../lib/ethers.js"),v=require("../../lib/external-wallets/displayHelpers.js"),y=require("../../lib/funding/analytics.js"),C=require("../../lib/funding/reservoir.js"),S=require("../../lib/wallets/actions/getBalanceForChains.js"),b=require("../../lib/wallets/actions/getErc20Balance.js"),E=require("../../utils/index.js"),w=require("../../utils/eth/getPublicClient.js"),I=require("../index.js"),T=require("./BridgeNetworkSelectionView.js"),A=require("./TransferOrBridgeLoadingScreen.js");function N(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("styled-components"),require("../../configuration/context.js"),require("../../config.js"),require("../../configuration/defaultClientConfig.js"),require("../../configuration/login-methods.js"),require("../../configuration/wallets.js"),require("../../connectors/chains/index.js"),require("../../connectors/chains/arbitrum.js"),require("../../connectors/chains/arbitrumSepolia.js"),require("../../connectors/chains/avalanche.js"),require("../../connectors/chains/avalancheFuji.js"),require("../../connectors/chains/base.js"),require("../../connectors/chains/baseSepolia.js"),require("../../connectors/chains/berachainArtio.js"),require("../../connectors/chains/celo.js"),require("../../connectors/chains/celoAlfajores.js"),require("../../connectors/chains/filecoin.js"),require("../../connectors/chains/filecoinCalibration.js"),require("../../connectors/chains/garnetHolesky.js"),require("../../connectors/chains/holesky.js"),require("../../connectors/chains/linea.js"),require("../../connectors/chains/lineaTestnet.js"),require("../../connectors/chains/lukso.js"),require("../../connectors/chains/mainnet.js"),require("../../connectors/chains/optimism.js"),require("../../connectors/chains/optimismSepolia.js"),require("../../connectors/chains/polygon.js"),require("../../connectors/chains/polygonAmoy.js"),require("../../connectors/chains/redstone.js"),require("../../connectors/chains/sepolia.js"),require("../../connectors/chains/zora.js"),require("../../connectors/chains/zoraSepolia.js"),require("../../connectors/chains/zoraTestnet.js"),require("../../lib/solana/index.js"),require("../../theme.js"),require("tinycolor2"),require("../../lib/cybr53.js"),require("../../svg/protected-by-privy.js"),require("../../components/ModalHeader.js"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("../../hooks/index.js"),require("ofetch"),require("../../components/PrefetchedImage.js"),require("../../hooks/useGetSolPrice.js"),require("../../connectors/get-legacy-injected-providers.js"),require("../../connectors/is-wallet-installed.js"),require("../../svg/backpack.js"),require("../../svg/brave-browser-icon.js"),require("../../svg/bybit.js"),require("../../svg/coinbase-wallet.js"),require("../../svg/cryptocom.js"),require("../../svg/metamask.js"),require("../../svg/okx-wallet.js"),require("../../svg/phantom.js"),require("../../svg/rabby.js"),require("../../svg/rainbow.js"),require("../../svg/safe.js"),require("../../svg/solflare.js"),require("../../svg/uniswap.js"),require("../../svg/universal-profile.js"),require("../../svg/wallet-connect.js"),require("../../svg/zerion.js"),require("@privy-io/js-sdk-core"),require("../../components/Button.js"),require("../../components/Loader.js"),require("../../components/ui/layout/Row.js"),require("../../components/ui/typography/ErrorMessage.js"),require("../../components/ui/typography/LabelSm.js"),require("../../components/ui/typography/Subtitle.js"),require("../../components/ui/typography/Title.js"),require("../../components/ui/wallet/NetworkBalanceCard.js"),require("@heroicons/react/24/outline/WalletIcon"),require("../../components/ui/chips/Chip.js"),require("../../components/ui/animation/LoadingSkeleton.js"),require("../../components/ui/typography/Value.js"),require("../../components/ui/wallet/NetworkIcon.js"),require("@heroicons/react/24/outline/GlobeAltIcon"),require("../../components/ui/icons/Arbitum.js"),require("../../components/ui/icons/Avalanche.js"),require("../../components/ui/icons/Base.js"),require("../../components/ui/icons/Celo.js"),require("../../components/ui/icons/Linea.js"),require("../../components/ui/icons/Mainnnet.js"),require("../../components/ui/icons/Optimism.js"),require("../../components/ui/icons/Polygon.js"),require("../../components/ui/icons/Solana.js"),require("../../components/ui/icons/Zora.js"),require("../../components/ui/wallet/shared.js"),require("../../components/ui/wallet/NetworkSelectorPanel.js"),require("@headlessui/react"),require("@heroicons/react/24/outline/ChevronDownIcon"),require("./styles.js"),require("../LinkPasskeyScreen.js"),require("@heroicons/react/24/outline/ClockIcon"),require("@heroicons/react/24/outline/TrashIcon"),require("@heroicons/react/24/solid/CheckBadgeIcon"),require("@heroicons/react/24/solid/LockClosedIcon"),require("../../hooks/privy-context.js"),require("../../svg/face-id.js"),require("../../svg/fingerprint.js"),require("../MfaScreens/StyledComponents.js"),require("../../components/external-wallets/InjectedWalletIcon.js"),require("../../components/ui/wallet/Address.js"),require("@heroicons/react/24/outline/CheckIcon"),require("@heroicons/react/24/outline/Square2StackIcon");var x=/*#__PURE__*/N(r);exports.AwaitingExternalTransferScreen=()=>{let{rpcConfig:r,appId:N,closePrivyModal:F,createAnalyticsEvent:k}=h.usePrivyInternal(),{navigate:P,setModalData:R,app:B,data:_}=q.usePrivyModal(),{wallets:W}=j.useWallets(),[M,L]=n.useState(!1),[U,D]=n.useState(0n),[O,G]=n.useState(!1),[H,$]=n.useState(null),[Q,z]=n.useState(null),[V,J]=n.useState([]),[X,Y]=n.useState(0),[Z,K]=n.useState(!1),[ee,re]=n.useState(!1),[ne,ie]=n.useState(!1),[te,se]=n.useState(!1);if(!_?.funding||"ethereum"!==_.funding.chainType)throw Error("Invalid funding data");let{erc20ContractInfo:oe,chain:ae,connectedWalletAddress:ce}=_.funding,ue=_.funding.address,le=_.funding.erc20Address,[de,he]=n.useState(_.funding.amount);n.useEffect((()=>{le&&!oe&&$(Error("Unable to fetch token details"))}),[]);let qe=!!le&&!!oe,ge=qe?BigInt(parseFloat(de)*10**oe.decimals):i.parseEther(de),je=ce?W.find((({address:e})=>e===ce)):W[0],[me,pe]=n.useState(null);n.useEffect((()=>{(async()=>{if(!je)return;let e=await je.getEthereumProvider();pe(i.createWalletClient({account:je.address,transport:i.custom(e)}).extend(i.publicActions))})().catch(console.error)}),[je]);let[fe,ve]=n.useState(0n);n.useEffect((()=>{i.createPublicClient({chain:ae,transport:i.http(w.getJsonRpcEndpointFromChain(ae,r,N))}).getBalance({address:ue}).then(ve).catch(console.error)}),[]);let[ye,Ce]=n.useState(0n);n.useEffect((()=>{qe&&b.getErc20Balance({chain:ae,address:ue,appId:N,rpcConfig:r,erc20Address:le}).then((e=>Ce(e.balance))).catch(console.error)}),[]);let{tokenPrice:Se}=g.useGetTokenPrice(ae.id),[be,Ee]=n.useState({to:ue,chain:ae,value:ge,data:void 0});n.useEffect((()=>{(async()=>{let e,n;if(!me||!je||Z||ne)return;K(!0);let t=i.createPublicClient({chain:be.chain,transport:i.http(w.getJsonRpcEndpointFromChain(be.chain,r,N))});if(qe&&!be.data)return await t.simulateContract({address:le,chain:be.chain,abi:m.ERC20_TRANSFER_ABI_STUB,functionName:"transfer",args:[ue,ge],account:je.address}).catch((e=>{console.warn("Simulated token transfer failed with error, fetching bridge options.",e)}))?(K(!1),void Ee({to:le,chain:be.chain,data:i.encodeFunctionData({abi:m.ERC20_TRANSFER_ABI_STUB,functionName:"transfer",args:[ue,ge]}),value:"0x0"})):(K(!1),void G(!0));try{e=await t.prepareTransactionRequest({account:je.address,to:be.to,chain:be.chain,data:be.data,value:BigInt(be.value??0)})}catch(e){if(console.error(e),V.length>1)z(e.shortMessage??"Something went wrong");else if(ee&&0===V.length)return void $(new d.PrivyClientError(`Wallet ${E.formatWalletAddress(je.address)} does not have enough funds.`,void 0,d.PrivyErrorCode.INSUFFICIENT_BALANCE))}if(!e)return K(!1),void G(!0);K(!1),ie(!0),L(!0),D(e.gas);try{await me.switchChain({id:be.chain.id})}catch(e){await me.addChain({chain:be.chain}),await me.switchChain({id:be.chain.id})}try{n=await me.sendTransaction(e),k({eventName:y.ON_RAMP_COMPLETE_ANALYTICS_EVENT,payload:{provider:"external",status:"success",address:je.address,chainId:be.chain.id,value:be.value?.toString(),txHash:n}})}catch(e){if(console.error(e),"TransactionExecutionError"===e.name)if(V.length<1){let r=e.shortMessage;(e.shortMessage.includes("rejected the request")||e.details.includes("rejected the request"))&&(r="User rejected the request."),$(new d.PrivyClientError(r,void 0,d.PrivyErrorCode.TRANSACTION_FAILURE))}else z(e.shortMessage??"Something went wrong")}n?(await me.waitForTransactionReceipt({hash:n}),ie(!1),se(!0)):ie(!1)})().catch(console.error)}),[me,be]),n.useEffect((()=>{(async()=>{if(!O||!me||!je)return;let e=u.addToDefaultChains(B.chains).filter((e=>e.id!==ae.id&&!!e.testnet==!!ae.testnet));qe&&e.unshift(ae);let n=await S.getBalanceForChains({chains:e,address:je.address,appId:N,rpcConfig:r}),i=qe?n.filter((e=>e.balance>0n)):n.filter((e=>e.balance>ge));if(i.length<1)return void $(new d.PrivyClientError(`Wallet ${E.formatWalletAddress(je.address)} does not have enough funds.`,void 0,d.PrivyErrorCode.INSUFFICIENT_BALANCE));i.sort(((e,r)=>Number(r.balance-e.balance)));let t=(await Promise.allSettled(i.map((async e=>({quote:await C.getQuote({isTestnet:!!ae.testnet,input:C.toGetQuoteInput({amount:ge.toString(),user:je.address,recipient:ue,destinationChainId:ae.id,destinationCurrency:le,originChainId:e.chain.id})}),...e}))))).filter((e=>"fulfilled"===e.status)).map((e=>e.value));if(t.length<1)return void $(new d.PrivyClientError(`Wallet ${E.formatWalletAddress(je.address)} does not have enough funds.`,void 0,d.PrivyErrorCode.INSUFFICIENT_BALANCE));let s=t.map((e=>({bridgeTx:C.toEvmTransactionRequestInfoFromQuote(e.quote),balance:e.balance,chain:e.chain}))).filter((e=>!!e.bridgeTx));if(s.length>1)return void J(s);let o=s[0];o?(re(!0),Ee({data:o.bridgeTx.data,to:o.bridgeTx.to,value:o.bridgeTx.value,chain:o.chain})):$(new d.PrivyClientError(`Wallet ${E.formatWalletAddress(je.address)} does not have enough funds.`,void 0,d.PrivyErrorCode.INSUFFICIENT_BALANCE))})().catch(console.error)}),[O]),n.useEffect((()=>{if(!H)return;let e={error:H,previousScreen:I.ModalScreen.FUNDING_TRANSFER_FROM_WALLET_SCREEN};R({funding:_?.funding,sendTransaction:_?.sendTransaction,errorModalData:e}),P(I.ModalScreen.ERROR_SCREEN,!1)}),[H]);let we=je?v.toDisplayName(je.walletClientType,je.connectorType,je.walletClientType)||"wallet":null,Ie=!qe&&Se?f.getDollarsFromStringFloat(de??"0",Se):void 0,Te=qe?U:f.sumWeiQuantities([U,ge]),Ae=Te&&Se?f.getDollarsFromWei(Te,Se):void 0,Ne=Te?f.getNativeCurrencyFromWei(Te,"ETH"):void 0,xe=U&&Se?f.getDollarsFromWei(U,Se):void 0,Fe=U?f.getNativeCurrencyFromWei(U,"ETH"):void 0;if(n.useEffect((()=>{if(!te)return;let e=setTimeout(F,l.DEFAULT_SUCCESS_SCREEN_EXTRA_LONG_DURATION_MS);return()=>clearTimeout(e)}),[te]),te/*#__PURE__*/)return e.jsxs(e.Fragment,{children:[/*#__PURE__*/e.jsx(a.default,{}),/*#__PURE__*/e.jsx(t.RefactorSpacerTop,{}),/*#__PURE__*/e.jsxs(t.CenteredItemWithGap,{children:[/*#__PURE__*/e.jsx(x.default,{color:"var(--privy-color-success)",width:"64px",height:"64px"}),/*#__PURE__*/e.jsx(o.CenteredScreenHeader,{title:"Success!",description:`Youâ€™ve successfully added ${de} ${qe?oe.symbol:ae.nativeCurrency.symbol} to your ${B.name} wallet. It may take a minute before the funds are available to use.`})]}),/*#__PURE__*/e.jsx(t.RefactorSpacerBottom,{}),/*#__PURE__*/e.jsx(s.BlobbyFooter,{})]});let ke=qe?`${p.formatErc20TokenAmount({amount:ye,decimals:oe.decimals})}  ${oe.symbol}`:f.getNativeCurrencyFromWei(fe,ae.nativeCurrency.symbol,3,!0),Pe=V[X];return V.length>1&&Pe?/*#__PURE__*/e.jsx(T.BridgeNetworkSelectionView,{displayName:we,configuredFundingChain:ae,formattedBalance:ke,fundingAmount:de,fundingCurrency:qe?oe.symbol:ae.nativeCurrency.symbol,fundingAmountInUsd:Ie,options:V,selectedOption:Pe,isPreparing:Z,isSubmitting:ne,addressToFund:ue,fundingWalletAddress:je?.address||"",errorMessage:Q,onSubmit:()=>{_.funding?.amount!==de?async function(){if(je&&Pe)try{let e=await C.getQuote({isTestnet:!!ae.testnet,input:C.toGetQuoteInput({amount:ge.toString(),user:je.address,recipient:ue,destinationChainId:ae.id,destinationCurrency:le,originChainId:Pe.chain.id})}),r=C.toEvmTransactionRequestInfoFromQuote(e);if(!r)throw Error("Invalid transaction request");re(!0),Ee({data:r.data,to:r.to,value:r.value,chain:Pe.chain})}catch(e){console.error(e),$(new d.PrivyClientError("Unable to fetch quotes for bridging",e,d.PrivyErrorCode.INSUFFICIENT_BALANCE))}}().catch(console.error):Ee({to:Pe.bridgeTx.to,data:Pe.bridgeTx.data,value:Pe.bridgeTx.value,chain:Pe.chain})},onSelect:e=>{e!==X&&(z(null),Y(e))},onAmountChange:he}):M&&U&&je&&_?.funding?/*#__PURE__*/e.jsx(A.TransferOrBridgeLoadingScreen,{wallet:je,displayName:we,addressToFund:ue,isBridging:ee,isErc20Flow:qe,totalPriceInUsd:Ae,totalPriceInNativeCurrency:Ne,gasPriceInUsd:xe,gasPriceInNativeCurrency:Fe,chainId:ae.id,chainName:ae.name}):
/*#__PURE__*/e.jsxs(e.Fragment,{children:[/*#__PURE__*/e.jsx(a.default,{}),/*#__PURE__*/e.jsx(c.NeutralSpinner,{}),/*#__PURE__*/e.jsx("div",{style:{marginTop:"1rem"}}),/*#__PURE__*/e.jsx(s.BlobbyFooter,{})]})};
